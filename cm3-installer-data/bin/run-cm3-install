#!/bin/bash
set -ex

echo "testing..."
$SNAP/bin/rpiboot -d $SNAP/msd
#http://cdimage.ubuntu.com/ubuntu-core/16/stable/current/ubuntu-core-16-cm3.img.xz
echo "starting image download..."
curl -L $1 |unxz -c |dd of=/dev/sda bs=4M oflag=sync
sync
partprobe /dev/sda
mount /dev/sda2 /mnt
if [ -d /mnt/system-data ]; then
    BASE=/mnt/system-data
else
    BASE=/mnt
fi
CLOUD_INIT_DIR=var/lib/cloud/seed/nocloud-net
mkdir -p $BASE/$CLOUD_INIT_DIR
cp $SNAP/cloud-data/* $BASE/$CLOUD_INIT_DIR
# This needs to be removed on eoan for rpi, else cloud-init
# won't find the user-data we give it and use one from
# /boot/firmware/user-data instead
rm -f $BASE/etc/cloud/cloud.cfg.d/99-fake_cloud.cfg
umount /mnt
